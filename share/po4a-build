#!/bin/sh
set -e

#  Copyright (C) 2006-2009  Neil Williams <codehelp@debian.org>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 3 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.

# pull in /usr/bin/gettext.sh
. gettext.sh

TEXTDOMAIN="po4a"
export TEXTDOMAIN
# this DIR might need to be configurable.
TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAINDIR

# DEFAULTS:
# name and location of the config file
# relative to the top level source directory of the translations
# i.e. the directory containing ./po/
CONFIG="po4a.config"
# PODIR po directory for manpages/docs
PODIR="po"
# POTFILE path
POTFILE=""
# base directory for generated files, e.g. doc
BASEDIR=""
# the binary packages that will contain generated manpages
BINARIES=""
# the binary packages with manpages in Section 3.
HASMAN3=""
# the binary packages using DocBook XML & xsltproc
XMLPACKAGES=""
# the DocBook XML files (TODO: let this take paths)
XMLFILE=""
# the pattern to find the XML files
XMLDIR=""
# the pattern to find the .docbook files
DOCBOOKDIR=""
# the XSL file to use for Docbook XSL
XSLFILE="http://docbook.sourceforge.net/release/xsl/current/manpages/docbook.xsl"
# the POD files (TODO: let this take paths)
PODFILE=""
# the binary packages using POD
PODPACKAGES=""
# html output (subdirectory of BASEDIR)
HTMLDIR=""
# html DocBook file
HTMLFILE=""
# the XSL file to use for Docbook XSL
HTMLXSL="http://docbook.sourceforge.net/release/xsl/current/html/chunk.xsl"

# remember to add something to the clean:: rule in debian/rules
# to remove each binary package sub-directory.
# $(RM) -r doc/emdebian-rootfs doc/multistrap

# below this point, no changes should be needed.

# use a default po4a-build.cnf in the current directory.
FILE="po4a-build.conf"

wrap_langs () {
	if [ -z "$LANGS" ]; then
		echo "$1 $2" >> $CONFIG
	else
		echo "$1 $2 $3" >> $CONFIG
	fi
}

usagehelp () {
	# print out help message
	eval_gettext "
po4a-build - po4a frontend

Syntax: po4a-build
        po4a-build --pot-only

Commands:
-?|-h|--help|-version:      print this help message and exit
--pot-only:                 only create the POT file

Options:
-f|--file FILE:             po4a-build.conf config file path

"; echo
}

while [ -n "$1" ]; do
case "$1" in
	--help|-h|-\?|--version)
		echo usagehelp
		exit;
	;;
	--pot-only)
		POTONLY=1
		shift
	;;
	-f|--file)
		shift
		FILE=$1
		shift
	;;
	*)
		com=$1
		eval_gettext "Unrecognised command: \$com"; echo
	exit;
	;;
esac
done

if [ ! -f "$FILE" ]; then
	# without config, there's nothing to do.
	eval_gettext "Cannot find config file! '\$FILE'"; echo
	exit 3
else
	. ./$FILE
fi
OURS=`pwd|tr -d '\n'`
cd `dirname $FILE`

# calculate the langs, automatically.
LANGS=`ls $PODIR/*.po 2>/dev/null || true`
if [ ! -z "$LANGS" ]; then
	LANGS=`ls $PODIR/*.po | sed -e 's/.*\/\(.*\)\.po/\1 /' || true`
fi
if [ ! -z "$LANGS" ]; then
	LANGS=`echo $LANGS|tr -d '\n'`
	echo "[po4a_langs] $LANGS" > $CONFIG
	else
	echo > $CONFIG
fi
wrap_langs "[po4a_paths]" "$POTFILE" "\$lang:$PODIR/\$lang.po"

if [ -n "$XMLDIR" ]; then
	for file in $XMLDIR/*.xml; do
		LOCAL=`basename $file`
		wrap_langs "[type:docbook]" "$file" "\$lang:$XMLDIR/\$lang/$LOCAL"
	done
fi
if [ -n "$DOCBOOKDIR" ]; then
	for file in $DOCBOOKDIR; do
		LOCAL=`basename $file`
		wrap_langs "[type:docbook]" "$file" "\$lang:$BASEDIR/\$lang/$LOCAL"
	done
fi
if [ -n "$PODFILE" ]; then
	for file in $PODFILE; do
		LOCAL=`basename $file`
		wrap_langs "[type:pod]" "$file" "\$lang:$BASEDIR/pod/1/\$lang/$LOCAL"
	done
fi
if [ -n "$POD7FILES" ]; then
	for file in $POD7FILES; do
		LOCAL=`basename $file`
		wrap_langs "[type:pod]" "$file" "\$lang:$BASEDIR/pod/7/\$lang/$LOCAL"
	done
fi
if [ -n "$PODMODULES" ]; then
	for file in $PODMODULES; do
		wrap_langs "[type:pod]" "$file" "\$lang:$BASEDIR/pod/3/\$lang/$file"
	done
fi

if [ "$POTONLY" = "1" ]; then
	# Allow internal builds within po4a
	if [ "$USE_INTERNAL_PO4A" = "yes" ]; then
		eval_gettext "Internal po4a from $OURS being used instead of /usr/bin/"; echo
		PERL5LIB=$OURS/lib perl $OURS/po4a --no-translations $CONFIG
	else
		po4a --no-translations $CONFIG
	fi
	exit
fi

for d in $BINARIES; do
	for l in $LANGS; do
		mkdir -p $BASEDIR/$d/man/$l/man1/
		if [ "$d" = "$HASMAN3" ]; then
			mkdir -p $BASEDIR/$d/man/$l/man3/
		fi
		if [ -n "$PODMODULES" ]; then
			mkdir -p $BASEDIR/$d/man/$l/man3/
		fi
		if [ -n "$HTMLDIR" ]; then
			mkdir -p $BASEDIR/$d/$l/$HTMLDIR/
		fi
		if [ -n "$POD7FILES" ]; then
			mkdir -p $BASEDIR/$d/man/$l/man7/
		fi
	done
	mkdir -p $BASEDIR/$d/man/man1/
	if [ "$d" = "$HASMAN3" ]; then
		mkdir -p $BASEDIR/$d/man/man3/
	fi
	mkdir -p $BASEDIR/pod/$l/
	if [ -n "$PODMODULES" ]; then
		mkdir -p $BASEDIR/$d/man/man3/
	fi
	if [ -n "$POD7FILES" ]; then
		mkdir -p $BASEDIR/$d/man/man7/
	fi
done

# use -k to create all XML even if untranslated or the XSL breaks the build.
if [ -n "$KEEP" ]; then
	K="-k $KEEP"
fi

# Allow internal builds within po4a
if [ "$USE_INTERNAL_PO4A" = "yes" ]; then
	eval_gettext "Internal po4a from $OURS being used instead of /usr/bin/"; echo
	PERL5LIB=$OURS/lib perl $OURS/po4a $K $CONFIG
else
	po4a $K $CONFIG
fi

for d in $BINARIES; do
	for P in $XMLPACKAGES; do
		if [ $d = $P ]; then
			for X in $XMLFILE; do
				eval_gettext "Processing untranslated files for $d . . ."; echo
				XML_CATALOG_FILES="/etc/xml/catalog" \
				xsltproc -o $BASEDIR/$P/man/ --nonet $XSLFILE $XMLDIR/$X
				if [ "$d" = "$HASMAN3" ]; then
					mv $BASEDIR/$P/man/*.3 $BASEDIR/$P/man/man3/
				else
					rm -f $BASEDIR/$P/man/*.3
				fi
				mv $BASEDIR/$P/man/*.1 $BASEDIR/$P/man/man1/
			done
		fi
	done
	for POD in $PODPACKAGES; do
		if [ $d = "$POD" ]; then
			for file in $PODFILE; do
				LOCAL=`basename $file`
				eval_gettext "Processing untranslated files for $file (1) . . ."; echo
				pod2man $file $BASEDIR/$POD/man/man1/$LOCAL.1
			done
			if [ -n "$PODMODULES" ]; then
				for file in $PODMODULES; do
					# a bit of sed magic to convert a path to a module name.
					name=`echo $file| sed -e 's/^lib\///'|sed -e 's/\//::/g'|sed -e 's/\.pm$//'`
					eval_gettext "Processing untranslated files for $name (3) . . ."; echo
					pod2man $file $BASEDIR/$POD/man/man3/$name.3
				done
			fi
			if [ -n "$POD7FILES" ]; then
				for file in $POD7FILES; do
					LOCAL=`basename $file`
					eval_gettext "Processing untranslated files for $file (7) . . ."; echo
					# shorten names that already contain the 7.
					SHORT=`echo $LOCAL|cut -d'7' -f1|tr -d .`
					if [ -n "$SHORT" ]; then
						pod2man -s 7 $file $BASEDIR/$POD/man/man7/${SHORT}.7
					else
						pod2man -s 7 $file $BASEDIR/$POD/man/man7/${LOCAL}.7
					fi
				done
			fi
		fi
	done
	if [ -n "$HTMLDIR" ]; then
		xsltproc -o $BASEDIR/$d/$HTMLDIR/ --nonet $HTMLXSL $XMLDIR/$HTMLFILE
	fi
	for l in $LANGS; do
		for P in $XMLPACKAGES; do
			if [ $d = "$P" ]; then
				for X in $XMLFILE; do
					if [ -f $XMLDIR/$l/$X ]; then
					eval_gettext "Processing $l translations for $d . . ."; echo
						XML_CATALOG_FILES="/etc/xml/catalog" \
						xsltproc -o $BASEDIR/$P/man/ --nonet $XSLFILE $XMLDIR/$l/$X
					fi
				done
				if [ "$d" = "$HASMAN3" ]; then
					mv $BASEDIR/$P/man/*.3 $BASEDIR/$P/man/$l/man3/
				else
					rm -f $BASEDIR/$P/man/*.3
				fi
				mv $BASEDIR/$P/man/*.1 $BASEDIR/$P/man/$l/man1/
			fi
		done
		for POD in $PODPACKAGES; do
			if [ $d = "$POD" ]; then
				for file in $PODFILE; do
					LOCAL=`basename $file`
					if [ -f $BASEDIR/pod/1/$l/$LOCAL ]; then
						eval_gettext "Processing $l translations for $file (1). . ."; echo
						pod2man $BASEDIR/pod/1/$l/$LOCAL $BASEDIR/$POD/man/$l/man1/$LOCAL.1
					fi
				done
			fi
			if [ -n "$PODMODULES" ]; then
				for file in $PODMODULES; do
					# a bit of sed magic to convert a path to a module name.
					name=`echo $file| sed -e 's/^lib\///'|sed -e 's/\//::/g'|sed -e 's/\.pm$//'`
					if [ -f $BASEDIR/pod/3/$l/$file ]; then
						eval_gettext "Processing $l translations for $name (3). . ."; echo
						pod2man $BASEDIR/pod/3/$l/$file $BASEDIR/$POD/man/$l/man3/$name.3
					fi
				done
			fi
			if [ -n "$POD7FILES" ]; then
				for file in $POD7FILES; do
					LOCAL=`basename $file`
					if [ -f $BASEDIR/pod/7/$l/$LOCAL ]; then
						eval_gettext "Processing $l translations for $file (7). . ."; echo
						# shorten names that already contain the 7.
						SHORT=`echo $LOCAL|cut -d'7' -f1|tr -d .`
						if [ -n "$SHORT" ]; then
							pod2man -s 7 $BASEDIR/pod/7/$l/$LOCAL $BASEDIR/$POD/man/$l/man7/${SHORT}.7
						else
							pod2man -s 7 $BASEDIR/pod/7/$l/$LOCAL $BASEDIR/$POD/man/$l/man7/$LOCAL.7
						fi
					fi
				done
			fi
		done
		if [ -n "$HTMLDIR" ]; then
			mkdir -p $BASEDIR/$d/$HTMLDIR/$l/
			xsltproc -o $BASEDIR/$d/$HTMLDIR/$l/ --nonet $HTMLXSL $XMLDIR/$l/$HTMLFILE
		fi
		done
		if [ -n "$HTMLDIR" ]; then
			for i in `ls $BASEDIR/$d/$HTMLDIR/*.html`; do
				iconv -t utf-8 -f iso8859-1 $i > $BASEDIR/$HTMLDIR/tmp
				sed < $BASEDIR/$HTMLDIR/tmp > $i -e 's:charset=ISO-8859-1:charset=UTF-8:'
			done
		fi
	if [ -n "$HTMLDIR" ]; then
		rm -f $BASEDIR/$HTMLDIR/tmp
	fi
done

for l in $LANGS; do
	rm -rf $XMLDIR/$l
done
rm -rf $BASEDIR/pod/
